---
title: OpenTSDB结果分页的实现以及思考
date: 2019-03-06 13:31:46
tags:
keywords: OpenTSDB, 时序数据库, OpenTSDB分页
---

## 简述

OpenTSDB 是一个较为热门的时序数据库，它基于相关后端：HBase, BigTable, Cassandra。

最近我们在做这方面的开发，有人提出一个需求OpenTSDB查询如何分页？一开始以为是一个很简单的需求，但是我在仔细查看文档后发现，OpenTSDB HTTP API 没有提供相关分页操作。

## 思考: 时序数据库分页是否是一个伪需求？

基于时序数据库的数据，主要存在以下两个应用：

1. 根据历史原始数据点进行数据分析和数据挖掘，甚至利用相关算法进行模型训练。

2. 数据的聚合展示，例如各种图形报表等等。

在应用（1）中，我们一般采用离线分析手段，需要的是一个较大规模的数据集，少量或者单个的数据点是没有意义的，所以在这种类型的应用中，我们主要应该解决大规模数据如何打包并下发给用户而不是考虑使用分页来让用户逐页提取。

在应用（2）中，因为展示的数据量不应过大，数据密度不宜过高，否则不易查看其规律，所以我们需要采用降采样后的数据点进行绘制。在实际应用的编写过程中展示数据点的聚合时间维度应该根据应用所需要查看的时间维度而定。

比如：我们需要查看一年某一个测点的数据走向，那么从整个查询时间维度上来讲，我们并不需要返回所有的原始数据点，我们应该以半个月或者10天左右的时间维度进行聚合，然后返回相关值。当用户需要查询更详细的数据的时候，他可以请求更小时间维度上的数据，比如查询某一天的测点数据走向，那么我们应该在每小时或者每半小时的时间维度上进行聚合。

所以在我看来在以上两个应用场景中，时序数据库的分页实际上是一个伪需求。

## 我不管，我们就是要分页!

现在我们来回归正题，在OpenTSDB中应该如何实现分页查询？

OpenTSDB 的HTTP API并没有提供相关分页实现，要实现分页请求我这里提供两个办法:

1. 根据分页参数进行时间区间切片划分，分别进行请求。
2. 不使用HTTP API，使用OpenTSDB源代码中的相关函数进行检索。

**方法（1）：**
把查找的时间范围进行分片，然后每页查询的时间范围就是时间分片之后的时间范围。

例如：我要查询最近10天时间范围的某个测点的数据，假设我们总共返回10页，那么我要查询第一页，则查询第一天到第二天的范围，查询第二页，则查询第三天到第三天的范围，以此类推。

**优点**： 
1. 简单，易懂。

**缺点**： 
1. 可能产生空点，比如我查询的每页限制条数为10条，可能设备离线或者什么原因，其中没有记录，那么这个时候，聚合值就两种处理方法，返回空或者0，如果是0的话，那么该条数据就产生了歧义：设备离线或者设备实际返回值为0。如果返回空值的话，那么数据条数就只有9条，会让接口调用者疑惑。

**方法（2）：**
OpenTSDB 源代码中定义了一个数据类型叫 [SeekableView](https://github.com/OpenTSDB/opentsdb/blob/master/src/core/SeekableView.java),它实际上是一个迭代器，我们可以通过它来实现分页功能，这里直接上代码。

{% gist "d0fa152a27c28438a59025f62c47f322" "TSDQueryMain.java" %}

**优点**： 
1. 查询效率高，结果返回良好。

**缺点**： 
1. 复杂度有所提升。
2. 由于所有的查询不使用OpenTSDB集群，所以在高可用环境下需要再部署一套查询集群，使用负载均衡器进行请求分发，后期维护的复杂度有所提升。


## 总结

OpenTSDB是一个设计良好的时序数据库，具体使用何种API，这个还得看各自的需求。

以我个人来讲，还是倾向于使用原生 API 来进行查询。虽然这么做会带来部署上的一些麻烦，但是以此换回更多的功能，以及更高的查询效率，这样的代价还是很值得的。